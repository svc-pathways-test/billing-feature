name: Build & Push Docker Images to JFrog

on:
  pull_request:
    branches: [main, staging]

env:
  JF_URL: https://trial6vs76y.jfrog.io/
  DOCKER_REPO: billing-feature-docker-local
  DOCKER_REGISTRY: trial6vs76y.jfrog.io

jobs:
  docker-build-push:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ env.JF_URL }}

      - name: Configure Docker for JFrog
        run: |
          jf docker-login ${{ env.DOCKER_REGISTRY }}

      - name: Set image tag
        id: tag
        run: |
          TAG="pr-${{ github.event.pull_request.number }}-${GITHUB_SHA::8}"
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT

      # ---- Backend ----
      - name: Build Backend Image
        working-directory: apps/api
        run: |
          jf docker build \
            --build-arg DIRECT_URL="" \
            --build-arg DATABASE_URL="" \
            --build-arg SENTRY_AUTH_TOKEN="" \
            --build-arg NEW_RELIC_LICENSE_KEY="" \
            --build-arg NEW_RELIC_APP_NAME="" \
            -t ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}/backend:${{ steps.tag.outputs.TAG }} \
            -f Dockerfile.backend .

      - name: Push Backend Image
        run: |
          jf docker push ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}/backend:${{ steps.tag.outputs.TAG }}

      # ---- Worker ----
      - name: Build Worker Image
        working-directory: apps/api
        run: |
          jf docker build \
            --build-arg DIRECT_URL="" \
            --build-arg DATABASE_URL="" \
            --build-arg SENTRY_AUTH_TOKEN="" \
            -t ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}/worker:${{ steps.tag.outputs.TAG }} \
            -f Dockerfile.worker .

      - name: Push Worker Image
        run: |
          jf docker push ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}/worker:${{ steps.tag.outputs.TAG }}

      # ---- Dev Server (multi-stage target: server) ----
      - name: Build Dev Server Image
        working-directory: apps/api
        run: |
          jf docker build \
            -t ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}/dev-server:${{ steps.tag.outputs.TAG }} \
            -f Dockerfile.dev --target server .

      - name: Push Dev Server Image
        run: |
          jf docker push ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}/dev-server:${{ steps.tag.outputs.TAG }}

      # ---- Dev Worker (multi-stage target: worker) ----
      - name: Build Dev Worker Image
        working-directory: apps/api
        run: |
          jf docker build \
            -t ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}/dev-worker:${{ steps.tag.outputs.TAG }} \
            -f Dockerfile.dev --target worker .

      - name: Push Dev Worker Image
        run: |
          jf docker push ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPO }}/dev-worker:${{ steps.tag.outputs.TAG }}

      # ---- Publish Build Info ----
      - name: Publish Build Info
        run: |
          jf rt build-publish "${{ github.repository }}" "${{ steps.tag.outputs.TAG }}"
